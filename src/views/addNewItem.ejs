<html>
  <head>
    <link rel="stylesheet" href="/styles.css" />
    <script>

    document.addEventListener("DOMContentLoaded", () => {
    const dialog = document.getElementById("confirmDialog");
    const deleteBtn = document.getElementById("newImageDltBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const confirmBtn = document.getElementById("confirmBtn");
    const itemImage = document.getElementById("newItemImage");
    const fileInput = document.getElementById("newItemImageInput");

    // Open dialog when delete icon clicked
    deleteBtn.addEventListener("click", () => {
      dialog.showModal();
    });

    // Close dialog
    cancelBtn.addEventListener("click", () => {
      dialog.close();
    });

    // Confirm delete
    confirmBtn.addEventListener("click", () => {
      dialog.close();
      itemImage.style.display = "none";

      if (deleteBtn) deleteBtn.style.display = "none";
      fileInput.style.display = "block"; // show file input
      fileInput.value = null; // Delete chosen file
    });

    fileInput.onchange = (e)=>{
      const [file] = fileInput.files;
      if (file){
        console.log({file});
        itemImage.src = URL.createObjectURL(file);
        itemImage.style.display = "block";
        deleteBtn.style.display = "flex"; // Show the delete icon
        fileInput.style.display = "none" // Hide the file input

      }
    }
  });


  function validateForm(event) {
    event.preventDefault();

    const item_name = document.getElementById("item_name").value.trim();
    const item_description = document.getElementById("item_description").value.trim();
    const item_price = document.getElementById("item_price").value.trim();
    const item_quantity = document.getElementById("item_quantity").value.trim();
    const category_id = document.getElementById("category_id").value.trim();
    const fileInput = document.getElementById("newItemImageInput");
    console.log(fileInput.files);
    const file = fileInput.files[0];

    console.log({item_price});
    // ===== Item Name =====
    if (!item_name) {
      alert("Item name is required.");
      return;
    }
    if (item_name.length > 255) {
      alert("Item name must not exceed 255 characters.");
      return;
    }

    // ===== Item Description =====
    if (!item_description) {
      alert("Item description is required.");
      return;
    }
    if (item_description.length > 255) {
      alert("Description must not exceed 255 characters.");
      return;
    }

    // ===== Item Price =====
    if (!item_price) {
      alert("Item price is required.");
      return;
    }
    const priceRegex = /^\d+(\.\d{1,2})?$/; // number with up to 2 decimals
    if (!priceRegex.test(item_price) || parseFloat(item_price) <= 0) {
      alert("Item price must be a number greater than 0 with up to 2 decimals.");
      return;
    }

    // ===== Item Quantity =====
    if (!item_quantity) {
      alert("Item quantity is required.");
      return;
    }
    if (!/^\d+$/.test(item_quantity) || parseInt(item_quantity, 10) < 0) {
      alert("Item quantity must be an integer 0 or more.");
      return;
    }

    // ===== Category =====
    if (category_id && (!/^\d+$/.test(category_id) || parseInt(category_id, 10) < 1)) {
      alert("Category ID must be a positive integer if provided.");
      return;
    }

    // ===== Item Image =====
    if (!file) {
      alert("Item image is required.");
      return;
    }
    const allowedTypes = ["image/jpeg", "image/png", "image/webp", "image/gif"];
    if (!allowedTypes.includes(file.type)) {
      alert("Only JPEG, PNG, WEBP or GIF images are allowed.");
      return;
    }
    if (file.size > 2 * 1024 * 1024) {
      alert("Image must be smaller than 2MB.");
      return;
    }


    document.getElementById("newItemForm").submit();
  }



    </script>
  </head>
  <body>
    <dialog id="confirmDialog">
      <h4>Are you sure you want to delete this image?</h4>
      <div class="dialogBtnWrapper">
        <button id="cancelBtn">Cancel</button>
        <button id="confirmBtn">Confirm</button>
      </div>
    </dialog>
    <%- include('header') %>
    <form
      id="newItemForm"
      method="post"
      action="/item/new"
      enctype="multipart/form-data"
      onsubmit="validateForm(event)"
    >
    <div class="inputContainer">
      <div class="labelInputWrapper">
        <label for="item_name">Item Name</label>
        <input
          class="nameInput"
          type="text"
          id="item_name"
          name="item_name"
          placeholder="Enter Item's name"
        />
      </div>

      <div class="labelInputWrapper">
        <label for="item_description">Item Description</label>
        <input
          class="nameInput"
          type="text"
          id="item_description"
          name="item_description"
          placeholder="Enter item description"
        />
      </div>

      <div class="labelInputWrapper">
        <label for="item_image">Item Image</label>

        <div class="newItemImageWrapper">
          <img id="newItemImage" class="newitemImage" src="" alt="Item Image" />
         
          <div id="newImageDltBtn" class="newImageDltBtn">
            <img class="deleteBtn" src="https://cdn-icons-png.flaticon.com/512/6861/6861362.png" alt="Image Delete Button" /> 
          </div>
        </div>

        <input
          class="newItemImageInput"
          type="file"
          id="newItemImageInput"
          name="item_image"
        />
      </div>

      <div class="labelInputWrapper">
        <label for="item_price">Item Price</label>

        <input
          class="nameInput"
          type="text"
          id="item_price"
          name="item_price"
          placeholder="Enter item price"
        />
      </div>

      <div class="labelInputWrapper">
        <label for="item_quantity">Item Quantity</label>

        <input
          class="nameInput"
          type="number"
          id="item_quantity"
          name="item_quantity"
          placeholder="Enter item quantity"
        />
      </div>

      <div class="labelInputWrapper">

      <label for="category_id">Select item's category</label>
      <select name="category_id" id="category_id" >
        <option value="" disabled selected hidden>Please select</option>
        <% categories.forEach((category, index)=> { %>
            <% const {category_id, category_name} = category %>
            <option value="<%= category_id %>" ><%= category_name %></option>
                
       <% }) %>
      </select>
    </div>
    <div class="labelInputWrapper">

    <button class="submitBtn" type="submit">Submit</button>
    </div>

    </div>
    </form>
  </body>
</html>
