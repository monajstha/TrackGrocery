<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles.css" />
    <title></title>
    <script>
       
       
  let isAdmin = false; // Flag to remember if credentials were validated
  let action = '';

  document.addEventListener("DOMContentLoaded", () => {
    const dialogs = document.querySelectorAll('[id*="credentialsDialog"]');
    const updateBtns = document.querySelectorAll('[id*="updateBtn"]');
    const deleteBtns = document.querySelectorAll('[id*="deleteBtn"]');

    const submitCredentialBtns = document.querySelectorAll('[id*="submitCredentialsBtn"]');

    // Show dialog only if isAdmin is false
    function handleActionClick(itemId, actionType) {
      if (isAdmin) {
        // perform the action directly
        if (actionType === "update") {
          window.location.href = `/item/update/${itemId}`;
        } else if (actionType === "delete") {
          document.getElementById(`deleteForm-${itemId}`).submit();
        }
        return;
      }

      // Show the credentials dialog
      const dialog = document.getElementById(`credentialsDialog-${itemId}`);
      dialog.showModal();
    }


    // Attach click events to update/delete buttons
    updateBtns.forEach((btn) => {
      const itemId = btn.id.split("-")[1];
      btn.addEventListener("click", (e) => {action='update'; handleActionClick(itemId, "update")});
    });

    deleteBtns.forEach((btn) => {
      const itemId = btn.id.split("-")[1];
      btn.addEventListener("click", (e) => {action='delete';handleActionClick(itemId, "delete")});
    });

    // Handle credential form submission
    submitCredentialBtns.forEach((btn) => {
      const itemId = btn.id.split("-")[1];

      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        const form = document.getElementById(`credentialsForm-${itemId}`);

        // Make POST request to your auth endpoint
        const res = await fetch(form.action, {
          method: "POST",
          headers: {'Content-Type': "application/json"},
          body: JSON.stringify({
            username: form.username.value,
            password: form.password.value,
          }),
        });
        console.log('ress',res);
        if (res.ok) {
          isAdmin = true; // Set flag so user won't see dialog again
          const dialog = document.getElementById(`credentialsDialog-${itemId}`);
          dialog.close();

          alert("Credentials validated. You can now perform actions.");
          handleActionClick(itemId, action);
        } else {
          alert("Invalid credentials.");
        }
      });
    });

    // Handle dialog cancel buttons
    const cancelBtns = document.querySelectorAll('[id*="cancelCredentialsBtn"]');
    cancelBtns.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const itemId = btn.id.split("-")[1];
        const dialog = document.getElementById(`credentialsDialog-${itemId}`);
        dialog.close();
      });
    });
  });

    
        function toggleMenu(item_id) {
          const menu = document.getElementById(`popupMenu-${item_id}`);
      
          // Close any other open menus first
          document.querySelectorAll('.popupMenu').forEach(m => {
            if (m !== menu) m.classList.add('hidden');
          });
      
          // Toggle current menu
          menu.classList.toggle('hidden');
        }
      
        // Close popup if clicked outside
        document.addEventListener('click', function(e) {
          if (!e.target.closest('.menuWrapper')) {
            document.querySelectorAll('.popupMenu').forEach(m => m.classList.add('hidden'));
          }
        });
      </script>

  </head>
  <body>
    <%- include('header') %>
    <!-- Item Delete confirm dialog -->
    <dialog id="confirmDialog">
        <h4>Are you sure you want to delete this item?</h4>
        <p>This action is irreversible.</p>
        <div class="dialogBtnWrapper">
            <button id="cancelBtn">Cancel</button>
            <button id="confirmBtn">Confirm</button>
        </div>
      </dialog>

 
   

    <!-- Category Select -->
    <form method="get" action="/">
        <select class="categorySelect" name="category" id="category" onchange="if(this.value===''){window.location='/' } else { this.form.submit(); }">
          <option value="" 
          <%= selectedCategory == "" ? "selected" : "" %>>All</option>
          <% categories.forEach((category, index)=> { %>
              <% const {category_id, category_name} = category %>
              <option value="<%= category_id %>" 
                  <%= selectedCategory == category_id ? "selected" : "" %>><%= category_name %></option>
         <% }) %>
        </select>
    </form>

    <!-- Items listing -->
    <div class="itemsDiv">
      <% items.forEach((item, index) => { %>
        <% const {item_id, item_name, item_description, item_image, item_price, item_quantity} = item %>
        <div class="itemContainer">
        <!-- Credentials dialog -->
        <dialog id="credentialsDialog-<%= item_id%>">
            <form id="credentialsForm-<%= item_id%>" method="post" action="/auth">
                <h4>Credentials Required!</h4>
                <p>This action can only be performed by an admin. Please enter your username and password.</p>

                <input id="username-<%= item_id%>" style="display: block; margin:5px 0" type="text" name="username" placeholder="Enter your username"/>
                <input id="password-<%= item_id%>"  type="password" name="password" placeholder="Enter your password"/>

                <div class="dialogBtnWrapper">
                    <button id="cancelCredentialsBtn-<%= item_id%>">Cancel</button>
                    <button id="submitCredentialsBtn-<%= item_id%>" type="submit">Submit</button>
                </div>
            </form>
        </dialog>
            <div class="menuWrapper">

                <img id="menuIcon-<%= item_id %>"  class="menuIcon" src="https://cdn-icons-png.flaticon.com/512/6065/6065255.png" alt="Menu Icon"  onclick="toggleMenu(<%= item_id %>)">
    
                    <!-- Hidden popup menu -->
                <div id="popupMenu-<%= item_id %>" class="popupMenu hidden">
                        <button id="updateBtn-<%= item_id %>">Update</button>
                    <form id="deleteForm-<%= item_id %>" method="post" action="/item/delete/<%= item_id %>?_method=DELETE">
                        <button id="deleteBtn-<%= item_id %>" type="button">Delete</button>
                    </form>
                </div>
            </div>
     

            <img class="itemImage" src="<%= item_image %>" alt="Item Image">
          <p class="itemName"><%= item_name %></p>
          <p class="itemDescription"><%= item_description %></p>
          <p class="itemPrice">Â£<%= item_price %></p>
          <p class="itemQuantity"> Only <%= item_quantity %> <%= item_quantity <=1 ? "item": "items"%> left</p>
        </div>
      <%} ) %>

    </div>

      
  </body>
</html>
