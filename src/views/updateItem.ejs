<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles.css" />
    <script>

    document.addEventListener("DOMContentLoaded", () => {
    const dialog = document.getElementById("confirmDialog");
    const deleteIcon = document.getElementById("imageDeleteBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const confirmBtn = document.getElementById("confirmBtn");
    const itemImage = document.getElementById("itemImage");
    const fileInput = document.getElementById("updateItemImageInput");

    // Open dialog when delete icon clicked
    deleteIcon.addEventListener("click", () => {
      dialog.showModal();
    });

    // Close dialog
    cancelBtn.addEventListener("click", () => {
      dialog.close();
    });

    // Confirm delete
    confirmBtn.addEventListener("click", () => {
      dialog.close();
      document.querySelector(".itemImage").style.display = "none";

      if (deleteIcon) deleteIcon.style.display = "none";
      fileInput.style.display = "block"; // show file input
      fileInput.value = null; // Delete chosen file
    });

    fileInput.onchange = (e)=>{
      const [file] = fileInput.files;
      if (file){
        itemImage.src = URL.createObjectURL(file);
        document.querySelector(".itemImage").style.display = "block";
        deleteIcon.style.display = "flex"; // Show the delete icon
        fileInput.style.display = "none" // Hide the file input
      }
    }
  });

      function validateForm(event) {
        event.preventDefault();

        const item_name = document.getElementById("item_name").value.trim();
        const item_description = document.getElementById("item_description").value.trim();
        const item_price = document.getElementById("item_price").value.trim();
        const item_quantity = document.getElementById("item_quantity").value.trim();
        const category_id = document.getElementById("category_id").value.trim();
        const existingImage = "<%= itemDetails.item_image %>";
        const fileInput = document.getElementById("updateItemImageInput");
        const file = fileInput?.files[0];
        
        // ===== Item Name =====
        if (!item_name) {
          alert("Item name is required.");
          return;
        }
        if (item_name.length > 255) {
          alert("Item name must not exceed 255 characters.");
          return;
        }

        // ===== Item Description =====
        if (!item_description) {
          alert("Item description is required.");
          return;
        }
        if (item_description.length > 255) {
          alert("Description must not exceed 255 characters.");
          return;
        }

        // ===== Item Price =====
        if (!item_price) {
          alert("Item price is required.");
          return;
        }
        const priceRegex = /^\d+(\.\d{1,2})?$/; // number with up to 2 decimals
        if (!priceRegex.test(item_price) || parseFloat(item_price) <= 0) {
          alert("Item price must be a number greater than 0 with up to 2 decimals.");
          return;
        }

        // ===== Item Quantity =====
        if (!item_quantity) {
          alert("Item quantity is required.");
          return;
        }
        if (!/^\d+$/.test(item_quantity) || parseInt(item_quantity, 10) < 0) {
          alert("Item quantity must be an integer 0 or more.");
          return;
        }

        // ===== Category =====
        if (category_id && (!/^\d+$/.test(category_id) || parseInt(category_id, 10) < 1)) {
          alert("Category ID must be a positive integer if provided.");
          return;
        }

        // ===== Item Image =====
        if (!file && !existingImage) {
          alert("Item image is required.");
          return;
        }

        if (file){
          const allowedTypes = ["image/jpeg", "image/png", "image/webp", "image/gif"];
          if (!allowedTypes.includes(file.type)) {
            alert("Only JPEG, PNG, WEBP or GIF images are allowed.");
            return;
          }
          if (file.size > 2 * 1024 * 1024) {
            alert("Image must be smaller than 2MB.");
            return;
          }
        }
 
        // If validation passes, submit the form
        document.getElementById('updateItemForm').submit();
      }
    </script>
  </head>
  <body>
    <dialog id="confirmDialog">
      <h4>Are you sure you want to delete this image?</h4>
      <div class="dialogBtnWrapper">
        <button id="cancelBtn">Cancel</button>
        <button id="confirmBtn">Confirm</button>
      </div>
    </dialog>
    <%- include('header') %>
    <form
      id="updateItemForm"
      method="post"
      action="/item/update/<%= itemDetails.item_id %>?_method=PUT"
      enctype="multipart/form-data"
      onsubmit="validateForm(event)"
    >
    <div class="inputContainer">
      <div class="labelInputWrapper">
        <label for="item_name">Item Name</label>
        <input
          class="nameInput"
          type="text"
          id="item_name"
          name="item_name"
          placeholder="Enter Item's name"
          value="<%= itemDetails.item_name %>"
        />
      </div>

      <div class="labelInputWrapper">
        <label for="item_description">Item Description</label>
        <input
          class="nameInput"
          type="text"
          id="item_description"
          name="item_description"
          placeholder="Enter item description"
          value="<%= itemDetails.item_description %>"
        />
      </div>

      <div class="labelInputWrapper">
        
        <label for="item_image">Item Image</label>

        <div class="imageDltBtnWrapper">
          <img id="itemImage" class="itemImage" src="<%= itemDetails.item_image %>" alt="<%= itemDetails.item_name %>" />
         
          <div id="imageDeleteBtn" class="deleteBtnWrapper">
            <img class="deleteBtn" src="https://cdn-icons-png.flaticon.com/512/6861/6861362.png" alt="Image Delete Button" /> 
          </div>
        </div>

        <input
          class="updateItemImageInput"
          type="file"
          id="updateItemImageInput"
          name="item_image"
          value="<%= itemDetails.item_image %>"
        />
      </div>

      <div class="labelInputWrapper">
        <label for="item_price">Item Price</label>

        <input
          class="nameInput"
          type="text"
          id="item_price"
          name="item_price"
          placeholder="Enter item price"
          value="<%= itemDetails.item_price %>"

        />
      </div>

      <div class="labelInputWrapper">
        <label for="item_quantity">Item Quantity</label>

        <input
          class="nameInput"
          type="number"
          id="item_quantity"
          name="item_quantity"
          placeholder="Enter item quantity"
          value="<%= itemDetails.item_quantity %>"

        />
      </div>

      <div class="labelInputWrapper">

      <label for="category_id">Select item's category</label>
      <select name="category_id" id="category_id" >
       
        <% categories.forEach((category, index)=> { %>
            <% const {category_id, category_name} = category %>
            <option value="<%= category_id %>" <%= itemDetails.category_id == category_id ? "selected" : "" %>><%= category_name %></option>
                
       <% }) %>
      </select>
    </div>
    <div class="labelInputWrapper">

    <button class="submitBtn" type="submit">Save Changes</button>
    </div>

    </div>
    </form>
  </body>
</html>
